<template>
    <div class="mt-10 h-screen min-h-700 w-80 mx-auto">
        <h1 class="title">Register</h1>
        <form class="w-72 md:w-80 mx-auto space-y-3" id="register" @submit="checkForm">
            <div class="flex flex-col ">
                <label>first name</label>
                <input 
                    type="text"
                    v-model="firstName"
                    placeholder="enter first name"
                />
            </div>
            <div class="flex flex-col ">
                <label>last name</label>
                <input 
                    type="text"
                    v-model="lastName"
                    placeholder="enter last name"
                />
            </div>
            <!-- <div class="flex flex-col ">
                <label>username</label>
                <input 
                    type="text"
                    v-model="username"
                    placeholder="enter username"
                />
            </div> -->
            <div class="flex flex-col ">
                <label for="email">email</label>
                <input
                    type="email"
                    name="email"
                    v-model="email"
                    placeholder="enter email"
                    required
                />
            </div>
            <div class="flex flex-col ">
                <label>password</label>
                <input 
                    type="password"
                    v-model="password"
                    placeholder="enter password"
                />
            </div>
            <div>
                <p v-show="error" class="text-pink-500">
                    {{this.errorMsg}}
                </p>
            </div>
            <div>
                <Button
                    text="register"
                    type="submit"
                    @click.prevent="register"
                    tailwindClass="btn-register"
                />
            </div>
        </form>
        <OauthButtons/>
    </div>
</template>

<script>
import Button from '../components/Button';
import OauthButtons from '../components/OauthButtons';
import db, { auth } from '../firebase/firebaseInit';
import { createUserWithEmailAndPassword } from 'firebase/auth';
import { setDoc, doc, arrayUnion } from 'firebase/firestore/lite';

export default {
    name: 'Register',
    components: {
        Button,
        OauthButtons
    },
    data () {
        return {
            firstName: "",
            lastName: "",
            // username: "",
            email: '',
            password: '',
            error: null,
            errorMsg: ""
        }
    },
    methods: {
        async register(e) {
            e.preventDefault();
            if(
                this.firstName !== "" &&
                this.lastName !== "" &&
                // this.username !== "" &&
                this.email !== "" &&
                this.password !== "" 
            ) {
                try{
                    // Create new account in Firebase Authentication database
                    const createUser = await createUserWithEmailAndPassword(auth, this.email, this.password);

                    const userDatabase = doc(db, `users/${createUser.user.uid}`);
                    const resultExist = localStorage.score ? arrayUnion({
                        "date/time": new Date(),
                        score: JSON.parse(localStorage.score)
                        }) : [];
                    const userData = {
                        firstName: this.firstName,
                        lastName: this.lastName,
                        // userName: this.username,
                        email: this.email,
                        results: resultExist,
                    };

                    // create new doc in Firebase Firestore database
                    await setDoc( userDatabase, userData );
                    localStorage.removeItem("score");
                    console.log('Saved to DB & score deleted');
                    // this.$router.go({ path: "/dashboard" });
                    this.$router.go({ path: this.$router.path });
                    
                } catch (err) {
                    this.error = true;
                    this.errorMsg = err.message.slice(10);
                }
                return;
            }
            this.error = true;
            this.errorMsg = "please fill out all the fields";
        }
    }
}
</script>

<style scope>
    .btn-register{
        @apply
            bg-primary
            w-full
            min-w-min
            outline-none
            focus:bg-pressed
            focus:ring-pink-300
            hover:bg-questions
            focus:ring-2
            focus:outline-none
            capitalize
            font-semibold
        ;
    }
    .title{
        @apply
            w-max
            mx-auto
            text-4xl
            py-5 font-medium
            text-transparent
            bg-gradient-to-b
            from-green-500
            to-blue-300
            bg-clip-text
        ;
    }
    label{
        @apply
            text-gray-600 capitalize;
    }
    input{
        @apply rounded-sm border-2 border-gray-100 p-2; 
    }
</style>